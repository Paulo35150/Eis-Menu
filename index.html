// =============== MENU DE PRODUTOS ATUALIZADO ===============

const menuItems = {
    'gelados': [
        {
            id: 1,
            name: 'PORTION',
            description: 'Duas bolas de gelado',
            price: 4.50,
            category: 'gelados',
            // 2 gostos incluídos automaticamente
            includedFlavors: 2,
            maxFlavors: 2, // MUDADO: Máximo 2 bolas, não 3
            options: []
        },
        {
            id: 2,
            name: 'BÄCHLE',
            description: 'Copo pequeno com 3 bolas',
            price: 5.50,
            category: 'gelados',
            includedFlavors: 3,
            maxFlavors: 3,
            options: []
        },
        {
            id: 3,
            name: 'GROSSES BÄCHLE',
            description: 'Copo grande com 4 bolas',
            price: 7.00,
            category: 'gelados',
            includedFlavors: 4,
            maxFlavors: 4,
            options: []
        }
    ],
    
    'bebidas': [
        {
            id: 4,
            name: 'Milchmix',
            description: 'Milkshake de gelado',
            price: 4.80,
            category: 'bebidas',
            // NOVO: Opção Sahne para bebidas
            options: [
                {
                    id: 'sahne',
                    name: 'Sahne',
                    choices: [
                        { id: 'com', name: 'Com Sahne', price: 0 },
                        { id: 'sem', name: 'Sem Sahne', price: 0 }
                    ],
                    required: true
                }
            ]
        },
        {
            id: 5,
            name: 'Eiscafé',
            description: 'Café gelado com gelado',
            price: 4.50,
            category: 'bebidas',
            // NOVO: Opção Sahne para bebidas
            options: [
                {
                    id: 'sahne',
                    name: 'Sahne',
                    choices: [
                        { id: 'com', name: 'Com Sahne', price: 0 },
                        { id: 'sem', name: 'Sem Sahne', price: 0 }
                    ],
                    required: true
                }
            ]
        },
        {
            id: 6,
            name: 'Eiscapucino',
            description: 'Capuccino gelado com gelado',
            price: 4.80,
            category: 'bebidas',
            // NOVO: Opção Sahne para bebidas
            options: [
                {
                    id: 'sahne',
                    name: 'Sahne',
                    choices: [
                        { id: 'com', name: 'Com Sahne', price: 0 },
                        { id: 'sem', name: 'Sem Sahne', price: 0 }
                    ],
                    required: true
                }
            ]
        },
        {
            id: 7,
            name: 'Eischokolade',
            description: 'Chocolate quente com gelado',
            price: 4.80,
            category: 'bebidas',
            // NOVO: Opção Sahne para bebidas
            options: [
                {
                    id: 'sahne',
                    name: 'Sahne',
                    choices: [
                        { id: 'com', name: 'Com Sahne', price: 0 },
                        { id: 'sem', name: 'Sem Sahne', price: 0 }
                    ],
                    required: true
                }
            ]
        }
    ],
    
    'snacks': [
        {
            id: 8,
            name: 'Waffels',
            description: 'Waffle quente',
            price: 3.50,
            category: 'snacks',
            // NOVO: Opção Sahne para snacks
            options: [
                {
                    id: 'sahne',
                    name: 'Sahne',
                    choices: [
                        { id: 'com', name: 'Com Sahne', price: 0 },
                        { id: 'sem', name: 'Sem Sahne', price: 0 }
                    ],
                    required: true
                }
            ]
        },
        {
            id: 9,
            name: 'Apfelstrudel',
            description: 'Strudel de maçã',
            price: 4.00,
            category: 'snacks',
            // NOVO: Opção Sahne para snacks
            options: [
                {
                    id: 'sahne',
                    name: 'Sahne',
                    choices: [
                        { id: 'com', name: 'Com Sahne', price: 0 },
                        { id: 'sem', name: 'Sem Sahne', price: 0 }
                    ],
                    required: true
                }
            ]
        }
    ]
};

// =============== SABORES DE GELADO ===============

const iceCreamFlavors = [
    { id: 1, name: 'Vanille', color: '#FFF8E1' },
    { id: 2, name: 'Schokolade', color: '#5D4037' },
    { id: 3, name: 'Erdbeere', color: '#F8BBD0' },
    { id: 4, name: 'Stracciatella', color: '#FFF8E1' },
    { id: 5, name: 'Haselnuss', color: '#8D6E63' },
    { id: 6, name: 'Zitrone', color: '#FFF9C4' },
    { id: 7, name: 'Mango', color: '#FFCC80' },
    { id: 8, name: 'Pistazie', color: '#C5E1A5' }
];

// =============== FUNÇÃO PARA ADICIONAR ITEM AO PEDIDO ===============

function addToOrder(itemId) {
    const item = getItemById(itemId);
    
    // Criar modal para opções
    const modal = createOptionsModal(item);
    document.body.appendChild(modal);
}

function createOptionsModal(item) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    `;
    
    let flavorSection = '';
    
    // Se for gelado, mostrar seção de SABORES (OPCIONAL)
    if (item.category === 'gelados') {
        const includedText = item.includedFlavors === 1 ? '1 bola incluída' : `${item.includedFlavors} bolas incluídas`;
        
        flavorSection = `
            <div class="flavor-section" style="margin: 20px 0; padding: 15px; background: #f9f9f9; border-radius: 8px;">
                <h4 style="margin-top: 0;">
                    <i class="fas fa-ice-cream"></i> Gostos de Gelado
                    <span style="font-size: 0.9em; color: #666; font-weight: normal;">
                        (${includedText} - ${item.maxFlavors} máximo)
                    </span>
                </h4>
                
                <div style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                    <strong>NOTA:</strong> ${item.includedFlavors} gosto(s) já incluído(s). 
                    Apenas selecione abaixo se quiser <strong>ALTERAR</strong> os gostos.
                </div>
                
                <div id="flavors-container" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                    ${iceCreamFlavors.map(flavor => `
                        <div class="flavor-option" 
                             data-id="${flavor.id}"
                             style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; background: white;">
                            <div style="width: 20px; height: 20px; border-radius: 50%; background: ${flavor.color}; display: inline-block; margin-right: 10px;"></div>
                            ${flavor.name}
                        </div>
                    `).join('')}
                </div>
                
                <div id="selected-flavors" style="margin-top: 15px; min-height: 40px; padding: 10px; border: 1px dashed #ddd; border-radius: 5px;">
                    <div style="color: #666; font-size: 0.9em;">
                        ${item.includedFlavors} gosto(s) padrão incluído(s)
                    </div>
                </div>
                
                <div style="margin-top: 10px; font-size: 0.8em; color: #666;">
                    <i class="fas fa-info-circle"></i> 
                    Se não selecionar nada, serão usados os gostos padrão.
                </div>
            </div>
        `;
    }
    
    // Seções de opções (Sahne para bebidas e snacks)
    let optionsSections = '';
    if (item.options && item.options.length > 0) {
        optionsSections = item.options.map(option => `
            <div class="option-section" style="margin: 15px 0;">
                <h4 style="margin-top: 0;">
                    <i class="fas fa-cog"></i> ${option.name}
                    ${option.required ? '<span style="color: #F44336;">*</span>' : ''}
                </h4>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    ${option.choices.map(choice => `
                        <button class="option-choice" 
                                data-option-id="${option.id}"
                                data-choice-id="${choice.id}"
                                style="padding: 10px 15px; border: 1px solid #ddd; background: white; border-radius: 5px; cursor: pointer;">
                            ${choice.name} ${choice.price > 0 ? `(+€${choice.price.toFixed(2)})` : ''}
                        </button>
                    `).join('')}
                </div>
            </div>
        `).join('');
    }
    
    modal.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;">${item.name}</h3>
                <button id="close-modal" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">
                    &times;
                </button>
            </div>
            
            <p style="color: #666; margin-bottom: 20px;">${item.description}</p>
            
            ${flavorSection}
            
            ${optionsSections}
            
            <div style="margin-top: 30px; display: flex; justify-content: space-between; align-items: center;">
                <div style="font-size: 1.5em; font-weight: bold; color: var(--primary);">
                    €${item.price.toFixed(2)}
                </div>
                <button id="add-to-cart" style="background: var(--primary); color: white; border: none; padding: 12px 30px; border-radius: 5px; font-size: 1.1em; cursor: pointer;">
                    <i class="fas fa-cart-plus"></i> Adicionar ao Pedido
                </button>
            </div>
        </div>
    `;
    
    // Event listeners
    modal.querySelector('#close-modal').addEventListener('click', () => {
        document.body.removeChild(modal);
    });
    
    modal.querySelector('#add-to-cart').addEventListener('click', () => {
        const selectedFlavors = [];
        const selectedOptions = {};
        
        // Coletar gostos selecionados (se houver)
        if (item.category === 'gelados') {
            const selectedFlavorElements = modal.querySelectorAll('.flavor-option.selected');
            selectedFlavorElements.forEach(el => {
                const flavorId = parseInt(el.dataset.id);
                const flavor = iceCreamFlavors.find(f => f.id === flavorId);
                if (flavor) selectedFlavors.push(flavor.name);
            });
        }
        
        // Coletar opções selecionadas
        if (item.options) {
            item.options.forEach(option => {
                const selectedChoice = modal.querySelector(`.option-choice.selected[data-option-id="${option.id}"]`);
                if (selectedChoice) {
                    selectedOptions[option.id] = selectedChoice.dataset.choiceId;
                }
            });
        }
        
        // Criar item do pedido
        const orderItem = {
            id: item.id,
            name: item.name,
            basePrice: item.price,
            flavors: selectedFlavors.length > 0 ? selectedFlavors : null, // null = usar gostos padrão
            options: Object.keys(selectedOptions).length > 0 ? selectedOptions : null,
            quantity: 1
        };
        
        // Adicionar ao carrinho
        addItemToCart(orderItem);
        
        // Mostrar notificação
        showNotification(`${item.name} adicionado ao pedido!`);
        
        // Fechar modal
        document.body.removeChild(modal);
    });
    
    // Selecionar gostos de gelado
    if (item.category === 'gelados') {
        modal.querySelectorAll('.flavor-option').forEach(option => {
            option.addEventListener('click', function() {
                const container = modal.querySelector('#selected-flavors');
                const selected = modal.querySelectorAll('.flavor-option.selected');
                
                // Se já atingiu o máximo, remover o primeiro
                if (selected.length >= item.maxFlavors && !this.classList.contains('selected')) {
                    selected[0].classList.remove('selected');
                }
                
                this.classList.toggle('selected');
                
                // Atualizar display
                const currentSelected = modal.querySelectorAll('.flavor-option.selected');
                if (currentSelected.length > 0) {
                    container.innerHTML = currentSelected.length + ' gosto(s) selecionado(s):<br>' + 
                        Array.from(currentSelected).map(el => {
                            const flavorId = parseInt(el.dataset.id);
                            const flavor = iceCreamFlavors.find(f => f.id === flavorId);
                            return `• ${flavor.name}`;
                        }).join('<br>');
                } else {
                    container.innerHTML = `
                        <div style="color: #666; font-size: 0.9em;">
                            ${item.includedFlavors} gosto(s) padrão incluído(s)
                        </div>
                    `;
                }
            });
        });
    }
    
    // Selecionar opções
    modal.querySelectorAll('.option-choice').forEach(button => {
        button.addEventListener('click', function() {
            const optionId = this.dataset.optionId;
            
            // Desmarcar outras opções do mesmo grupo
            modal.querySelectorAll(`.option-choice[data-option-id="${optionId}"]`).forEach(btn => {
                btn.classList.remove('selected');
                btn.style.background = 'white';
                btn.style.borderColor = '#ddd';
            });
            
            // Marcar esta
            this.classList.add('selected');
            this.style.background = 'var(--primary)';
            this.style.borderColor = 'var(--primary)';
            this.style.color = 'white';
        });
    });
    
    return modal;
}

// =============== FUNÇÕES AUXILIARES ===============

function getItemById(id) {
    for (const category in menuItems) {
        const item = menuItems[category].find(item => item.id === id);
        if (item) return item;
    }
    return null;
}

function addItemToCart(orderItem) {
    // Implementar lógica do carrinho aqui
    console.log('Item adicionado ao carrinho:', orderItem);
}

function showNotification(message) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--success);
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        z-index: 10000;
        animation: slideIn 0.3s ease;
    `;
    
    notification.innerHTML = `
        <i class="fas fa-check-circle"></i> ${message}
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => document.body.removeChild(notification), 300);
    }, 3000);
}

// Adicionar estilos CSS para animações
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
    
    .flavor-option.selected {
        background: var(--primary) !important;
        color: white !important;
        border-color: var(--primary) !important;
    }
    
    .option-choice.selected {
        background: var(--primary) !important;
        color: white !important;
        border-color: var(--primary) !important;
    }
`;
document.head.appendChild(style);
